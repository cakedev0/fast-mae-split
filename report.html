<p><strong>TL;DR</strong>: Maintain the weighted <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.4306em;"></span><span style="margin-right: 0.0037em;">α</span></span></span></span>-quantile with two heaps, update four aggregates, and evaluate pinball loss in <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>1</span><span>)</span></span></span></span> per threshold. You get <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n\log n)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>n</span><span style="margin-right: 0.1667em;"></span><span>lo<span style="margin-right: 0.01389em;">g</span></span><span style="margin-right: 0.1667em;"></span><span>n</span><span>)</span></span></span></span> expected time under mild conditions, with a clean <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n\log n)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>n</span><span style="margin-right: 0.1667em;"></span><span>lo<span style="margin-right: 0.01389em;">g</span></span><span style="margin-right: 0.1667em;"></span><span>n</span><span>)</span></span></span></span> worst-case alternative via a segment tree when needed.</p>
<h1 id="efficient-weighted-quantilebased-splitting-for-decision-trees">Efficient Weighted Quantile–Based Splitting for Decision Trees</h1>
<p>This repository provides an efficient implementation of quantile-based impurities (pinball loss)
for decision-tree regression with <strong>weighted samples</strong> and <strong>arbitrary quantile levels</strong> <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>∈</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\alpha\in[0,1]</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.5782em; vertical-align: -0.0391em;"></span><span style="margin-right: 0.0037em;">α</span><span style="margin-right: 0.2778em;"></span><span>∈</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 1em; vertical-align: -0.25em;"></span><span>[</span><span>0</span><span>,</span><span style="margin-right: 0.1667em;"></span><span>1</span><span>]</span></span></span></span>.</p>
<ul>
<li><strong>Two-heaps method (default):</strong> Expected <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n\log n)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>n</span><span style="margin-right: 0.1667em;"></span><span>lo<span style="margin-right: 0.01389em;">g</span></span><span style="margin-right: 0.1667em;"></span><span>n</span><span>)</span></span></span></span> per feature under mild assumptions; very fast in practice.
This was implemented in scikit-learn in PR <a href="https://github.com/scikit-learn/scikit-learn/pull/32100">#32100</a>
for the absolute error case (<span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>=</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">\alpha = 0.5</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.4306em;"></span><span style="margin-right: 0.0037em;">α</span><span style="margin-right: 0.2778em;"></span><span>=</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.6444em;"></span><span>0.5</span></span></span></span>) replacing an <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^2)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1.0641em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span><span>n</span><span><span><span><span style="height: 0.8141em;"><span style="top: -3.063em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>2</span></span></span></span></span></span></span></span><span>)</span></span></span></span> implementation.
A future PR will generalize to <strong>arbitrary quantile levels</strong>.</li>
<li><strong>Segment tree alternative:</strong> Worst-case <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n\log n)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>n</span><span style="margin-right: 0.1667em;"></span><span>lo<span style="margin-right: 0.01389em;">g</span></span><span style="margin-right: 0.1667em;"></span><span>n</span><span>)</span></span></span></span> per feature by design; typically ~3× slower than two-heaps in benchmarks, but provides a clean theoretical upper bound.</li>
</ul>
<hr>
<h2 id="1-pinball-loss-with-weights-and-an-o1o1o1-formula">1. Pinball loss with weights and an <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>1</span><span>)</span></span></span></span> formula</h2>
<p>For weighted data <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mrow><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>w</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></msubsup></mrow><annotation encoding="application/x-tex">{(y_i,w_i)}_{i=1}^n</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1.104em; vertical-align: -0.2997em;"></span><span><span><span>(</span><span><span style="margin-right: 0.03588em;">y</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span>,</span><span style="margin-right: 0.1667em;"></span><span><span style="margin-right: 0.02691em;">w</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span>)</span></span><span><span><span><span style="height: 0.8043em;"><span style="top: -2.4003em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span><span>i</span><span>=</span><span>1</span></span></span></span><span style="top: -3.2029em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>n</span></span></span></span><span>​</span></span><span><span style="height: 0.2997em;"><span></span></span></span></span></span></span></span></span></span> with <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mi>i</mi></msub><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">w_i &gt; 0</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.6891em; vertical-align: -0.15em;"></span><span><span style="margin-right: 0.02691em;">w</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span style="margin-right: 0.2778em;"></span><span>&gt;</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.6444em;"></span><span>0</span></span></span></span>, the pinball loss at level <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>∈</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\alpha\in[0,1]</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.5782em; vertical-align: -0.0391em;"></span><span style="margin-right: 0.0037em;">α</span><span style="margin-right: 0.2778em;"></span><span>∈</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 1em; vertical-align: -0.25em;"></span><span>[</span><span>0</span><span>,</span><span style="margin-right: 0.1667em;"></span><span>1</span><span>]</span></span></span></span> for a prediction <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi><mo>∈</mo><mi mathvariant="double-struck">R</mi></mrow><annotation encoding="application/x-tex">q\in\mathbb{R}</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.7335em; vertical-align: -0.1944em;"></span><span style="margin-right: 0.03588em;">q</span><span style="margin-right: 0.2778em;"></span><span>∈</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.6889em;"></span><span>R</span></span></span></span> is</p>
<span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>L</mi><mi>α</mi></msub><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo><mo>=</mo><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>w</mi><mi>i</mi></msub><mrow><mo fence="true">(</mo><mi>α</mi><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo>−</mo><mi>q</mi><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>α</mi><mo stretchy="false">)</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>q</mi><mo>−</mo><msub><mi>y</mi><mi>i</mi></msub><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">L_\alpha(q)
= \sum_{i} w_i \left(\alpha\max(y_i-q,0) + (1-\alpha)\max(q-y_i,0)\right).</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span><span>L</span><span><span><span><span style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span style="margin-right: 0.0037em;">α</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span>(</span><span style="margin-right: 0.03588em;">q</span><span>)</span><span style="margin-right: 0.2778em;"></span><span>=</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 2.3277em; vertical-align: -1.2777em;"></span><span><span><span><span style="height: 1.05em;"><span style="top: -1.8723em; margin-left: 0em;"><span style="height: 3.05em;"></span><span><span><span>i</span></span></span></span><span style="top: -3.05em;"><span style="height: 3.05em;"></span><span><span>∑</span></span></span></span><span>​</span></span><span><span style="height: 1.2777em;"><span></span></span></span></span></span><span style="margin-right: 0.1667em;"></span><span><span style="margin-right: 0.02691em;">w</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span style="margin-right: 0.1667em;"></span><span><span style="top: 0em;">(</span><span style="margin-right: 0.0037em;">α</span><span style="margin-right: 0.1667em;"></span><span>max</span><span>(</span><span><span style="margin-right: 0.03588em;">y</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span style="margin-right: 0.2222em;"></span><span>−</span><span style="margin-right: 0.2222em;"></span><span style="margin-right: 0.03588em;">q</span><span>,</span><span style="margin-right: 0.1667em;"></span><span>0</span><span>)</span><span style="margin-right: 0.2222em;"></span><span>+</span><span style="margin-right: 0.2222em;"></span><span>(</span><span>1</span><span style="margin-right: 0.2222em;"></span><span>−</span><span style="margin-right: 0.2222em;"></span><span style="margin-right: 0.0037em;">α</span><span>)</span><span style="margin-right: 0.1667em;"></span><span>max</span><span>(</span><span style="margin-right: 0.03588em;">q</span><span style="margin-right: 0.2222em;"></span><span>−</span><span style="margin-right: 0.2222em;"></span><span><span style="margin-right: 0.03588em;">y</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span>,</span><span style="margin-right: 0.1667em;"></span><span>0</span><span>)</span><span style="top: 0em;">)</span></span><span style="margin-right: 0.1667em;"></span><span>.</span></span></span></span></span>
<p>Splitting by whether <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub><mo>≥</mo><mi>q</mi></mrow><annotation encoding="application/x-tex">y_i\ge q</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.8304em; vertical-align: -0.1944em;"></span><span><span style="margin-right: 0.03588em;">y</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span style="margin-right: 0.2778em;"></span><span>≥</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.625em; vertical-align: -0.1944em;"></span><span style="margin-right: 0.03588em;">q</span></span></span></span> or <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub><mo>&lt;</mo><mi>q</mi></mrow><annotation encoding="application/x-tex">y_i &lt; q</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.7335em; vertical-align: -0.1944em;"></span><span><span style="margin-right: 0.03588em;">y</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span style="margin-right: 0.2778em;"></span><span>&lt;</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.625em; vertical-align: -0.1944em;"></span><span style="margin-right: 0.03588em;">q</span></span></span></span>, define the aggregates</p>
<span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>W</mi><mo>+</mo></msup><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo><mo>=</mo><munder><mo>∑</mo><mrow><msub><mi>y</mi><mi>i</mi></msub><mo>≥</mo><mi>q</mi></mrow></munder><msub><mi>w</mi><mi>i</mi></msub><mo separator="true">,</mo><mspace width="1em"></mspace><msup><mi>Y</mi><mo>+</mo></msup><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo><mo>=</mo><munder><mo>∑</mo><mrow><msub><mi>y</mi><mi>i</mi></msub><mo>≥</mo><mi>q</mi></mrow></munder><msub><mi>w</mi><mi>i</mi></msub><msub><mi>y</mi><mi>i</mi></msub><mo separator="true">,</mo><mspace width="2em"></mspace><msup><mi>W</mi><mo>−</mo></msup><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo><mo>=</mo><munder><mo>∑</mo><mrow><msub><mi>y</mi><mi>i</mi></msub><mo>&lt;</mo><mi>q</mi></mrow></munder><msub><mi>w</mi><mi>i</mi></msub><mo separator="true">,</mo><mspace width="1em"></mspace><msup><mi>Y</mi><mo>−</mo></msup><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo><mo>=</mo><munder><mo>∑</mo><mrow><msub><mi>y</mi><mi>i</mi></msub><mo>&lt;</mo><mi>q</mi></mrow></munder><msub><mi>w</mi><mi>i</mi></msub><msub><mi>y</mi><mi>i</mi></msub><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">W^+(q)= \sum_{y_i\ge q} w_i,\quad
Y^+(q)= \sum_{y_i\ge q} w_i y_i,\qquad
W^-(q)= \sum_{y_i&lt; q} w_i,\quad
Y^-(q)= \sum_{y_i&lt; q} w_i y_i.</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1.0713em; vertical-align: -0.25em;"></span><span><span style="margin-right: 0.13889em;">W</span><span><span><span><span style="height: 0.8213em;"><span style="top: -3.113em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>+</span></span></span></span></span></span></span></span><span>(</span><span style="margin-right: 0.03588em;">q</span><span>)</span><span style="margin-right: 0.2778em;"></span><span>=</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 2.4473em; vertical-align: -1.3973em;"></span><span><span><span><span style="height: 1.05em;"><span style="top: -1.8888em; margin-left: 0em;"><span style="height: 3.05em;"></span><span><span><span><span style="margin-right: 0.03588em;">y</span><span><span><span><span style="height: 0.3281em;"><span style="top: -2.357em; margin-left: -0.0359em; margin-right: 0.0714em;"><span style="height: 2.5em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.143em;"><span></span></span></span></span></span></span><span>≥</span><span style="margin-right: 0.03588em;">q</span></span></span></span><span style="top: -3.05em;"><span style="height: 3.05em;"></span><span><span>∑</span></span></span></span><span>​</span></span><span><span style="height: 1.3973em;"><span></span></span></span></span></span><span style="margin-right: 0.1667em;"></span><span><span style="margin-right: 0.02691em;">w</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span>,</span><span style="margin-right: 1em;"></span><span style="margin-right: 0.1667em;"></span><span><span style="margin-right: 0.22222em;">Y</span><span><span><span><span style="height: 0.8213em;"><span style="top: -3.113em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>+</span></span></span></span></span></span></span></span><span>(</span><span style="margin-right: 0.03588em;">q</span><span>)</span><span style="margin-right: 0.2778em;"></span><span>=</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 2.4473em; vertical-align: -1.3973em;"></span><span><span><span><span style="height: 1.05em;"><span style="top: -1.8888em; margin-left: 0em;"><span style="height: 3.05em;"></span><span><span><span><span style="margin-right: 0.03588em;">y</span><span><span><span><span style="height: 0.3281em;"><span style="top: -2.357em; margin-left: -0.0359em; margin-right: 0.0714em;"><span style="height: 2.5em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.143em;"><span></span></span></span></span></span></span><span>≥</span><span style="margin-right: 0.03588em;">q</span></span></span></span><span style="top: -3.05em;"><span style="height: 3.05em;"></span><span><span>∑</span></span></span></span><span>​</span></span><span><span style="height: 1.3973em;"><span></span></span></span></span></span><span style="margin-right: 0.1667em;"></span><span><span style="margin-right: 0.02691em;">w</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span><span style="margin-right: 0.03588em;">y</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span>,</span><span style="margin-right: 2em;"></span><span style="margin-right: 0.1667em;"></span><span><span style="margin-right: 0.13889em;">W</span><span><span><span><span style="height: 0.8213em;"><span style="top: -3.113em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>−</span></span></span></span></span></span></span></span><span>(</span><span style="margin-right: 0.03588em;">q</span><span>)</span><span style="margin-right: 0.2778em;"></span><span>=</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 2.4361em; vertical-align: -1.3861em;"></span><span><span><span><span style="height: 1.05em;"><span style="top: -1.9em; margin-left: 0em;"><span style="height: 3.05em;"></span><span><span><span><span style="margin-right: 0.03588em;">y</span><span><span><span><span style="height: 0.3281em;"><span style="top: -2.357em; margin-left: -0.0359em; margin-right: 0.0714em;"><span style="height: 2.5em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.143em;"><span></span></span></span></span></span></span><span>&lt;</span><span style="margin-right: 0.03588em;">q</span></span></span></span><span style="top: -3.05em;"><span style="height: 3.05em;"></span><span><span>∑</span></span></span></span><span>​</span></span><span><span style="height: 1.3861em;"><span></span></span></span></span></span><span style="margin-right: 0.1667em;"></span><span><span style="margin-right: 0.02691em;">w</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span>,</span><span style="margin-right: 1em;"></span><span style="margin-right: 0.1667em;"></span><span><span style="margin-right: 0.22222em;">Y</span><span><span><span><span style="height: 0.8213em;"><span style="top: -3.113em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>−</span></span></span></span></span></span></span></span><span>(</span><span style="margin-right: 0.03588em;">q</span><span>)</span><span style="margin-right: 0.2778em;"></span><span>=</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 2.4361em; vertical-align: -1.3861em;"></span><span><span><span><span style="height: 1.05em;"><span style="top: -1.9em; margin-left: 0em;"><span style="height: 3.05em;"></span><span><span><span><span style="margin-right: 0.03588em;">y</span><span><span><span><span style="height: 0.3281em;"><span style="top: -2.357em; margin-left: -0.0359em; margin-right: 0.0714em;"><span style="height: 2.5em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.143em;"><span></span></span></span></span></span></span><span>&lt;</span><span style="margin-right: 0.03588em;">q</span></span></span></span><span style="top: -3.05em;"><span style="height: 3.05em;"></span><span><span>∑</span></span></span></span><span>​</span></span><span><span style="height: 1.3861em;"><span></span></span></span></span></span><span style="margin-right: 0.1667em;"></span><span><span style="margin-right: 0.02691em;">w</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span><span style="margin-right: 0.03588em;">y</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span>.</span></span></span></span></span>
<p>Then</p>
<span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><menclose notation="box"><mstyle scriptlevel="0" displaystyle="false"><mstyle scriptlevel="0" displaystyle="false"><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi>L</mi><mi>α</mi></msub><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo><mo>=</mo><mi>α</mi><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><msup><mi>Y</mi><mo>+</mo></msup><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo><mo>−</mo><mi>q</mi><msup><mi>W</mi><mo>+</mo></msup><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>α</mi><mo stretchy="false">)</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mi>q</mi><msup><mi>W</mi><mo>−</mo></msup><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo><mo>−</mo><msup><mi>Y</mi><mo>−</mo></msup><mo stretchy="false">(</mo><mi>q</mi><mo stretchy="false">)</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo></mrow></mstyle></mstyle></mstyle></menclose></mrow><annotation encoding="application/x-tex">\boxed{L_\alpha(q)
= \alpha\big(Y^+(q) - q W^+(q)\big)
+ (1-\alpha)\big(q W^-(q)-Y^-(q)\big)}</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1.88em; vertical-align: -0.69em;"></span><span><span><span><span style="height: 1.19em;"><span style="top: -3.88em;"><span style="height: 3.88em;"></span><span><span><span><span><span>L</span><span><span><span><span style="height: 0.1514em;"><span style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span style="margin-right: 0.0037em;">α</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span>(</span><span style="margin-right: 0.03588em;">q</span><span>)</span><span style="margin-right: 0.2778em;"></span><span>=</span><span style="margin-right: 0.2778em;"></span><span style="margin-right: 0.0037em;">α</span><span><span>(</span></span><span><span style="margin-right: 0.22222em;">Y</span><span><span><span><span style="height: 0.8213em;"><span style="top: -3.113em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>+</span></span></span></span></span></span></span></span><span>(</span><span style="margin-right: 0.03588em;">q</span><span>)</span><span style="margin-right: 0.2222em;"></span><span>−</span><span style="margin-right: 0.2222em;"></span><span style="margin-right: 0.03588em;">q</span><span><span style="margin-right: 0.13889em;">W</span><span><span><span><span style="height: 0.8213em;"><span style="top: -3.113em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>+</span></span></span></span></span></span></span></span><span>(</span><span style="margin-right: 0.03588em;">q</span><span>)</span><span><span>)</span></span><span style="margin-right: 0.2222em;"></span><span>+</span><span style="margin-right: 0.2222em;"></span><span>(</span><span>1</span><span style="margin-right: 0.2222em;"></span><span>−</span><span style="margin-right: 0.2222em;"></span><span style="margin-right: 0.0037em;">α</span><span>)</span><span><span>(</span></span><span style="margin-right: 0.03588em;">q</span><span><span style="margin-right: 0.13889em;">W</span><span><span><span><span style="height: 0.8213em;"><span style="top: -3.113em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>−</span></span></span></span></span></span></span></span><span>(</span><span style="margin-right: 0.03588em;">q</span><span>)</span><span style="margin-right: 0.2222em;"></span><span>−</span><span style="margin-right: 0.2222em;"></span><span><span style="margin-right: 0.22222em;">Y</span><span><span><span><span style="height: 0.8213em;"><span style="top: -3.113em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>−</span></span></span></span></span></span></span></span><span>(</span><span style="margin-right: 0.03588em;">q</span><span>)</span><span><span>)</span></span></span></span></span></span><span style="top: -3.19em;"><span style="height: 3.88em;"></span><span style="height: 1.88em; border-style: solid; border-width: 0.04em;"></span></span></span><span>​</span></span><span><span style="height: 0.69em;"><span></span></span></span></span></span></span></span></span></span>
<p>which is <strong><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>1</span><span>)</span></span></span></span></strong> to evaluate once the four aggregates are maintained.</p>
<p><strong>Code (notation: <code>alpha</code> is the level, <code>q</code> is the value):</strong></p>
<pre><pre><div style="color: rgb(171, 178, 191); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px;"><span>loss </span><span style="color: rgb(97, 175, 239);">=</span><span> </span><span style="color: rgb(171, 178, 191);">(</span><span></span></div><div style="color: rgb(171, 178, 191); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px;"><span>    alpha </span><span style="color: rgb(97, 175, 239);">*</span><span> </span><span style="color: rgb(171, 178, 191);">(</span><span>above</span><span style="color: rgb(171, 178, 191);">.</span><span>weighted_sum </span><span style="color: rgb(97, 175, 239);">-</span><span> q </span><span style="color: rgb(97, 175, 239);">*</span><span> above</span><span style="color: rgb(171, 178, 191);">.</span><span>total_weight</span><span style="color: rgb(171, 178, 191);">)</span><span></span></div><div style="color: rgb(171, 178, 191); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px;"><span>     </span><span style="color: rgb(97, 175, 239);">+</span><span> </span><span style="color: rgb(171, 178, 191);">(</span><span style="color: rgb(209, 154, 102);">1</span><span> </span><span style="color: rgb(97, 175, 239);">-</span><span> alpha</span><span style="color: rgb(171, 178, 191);">)</span><span> </span><span style="color: rgb(97, 175, 239);">*</span><span> </span><span style="color: rgb(171, 178, 191);">(</span><span>q </span><span style="color: rgb(97, 175, 239);">*</span><span> below</span><span style="color: rgb(171, 178, 191);">.</span><span>total_weight </span><span style="color: rgb(97, 175, 239);">-</span><span> below</span><span style="color: rgb(171, 178, 191);">.</span><span>weighted_sum</span><span style="color: rgb(171, 178, 191);">)</span><span></span></div><div style="color: rgb(171, 178, 191); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px;"><span></span><span style="color: rgb(171, 178, 191);">)</span><span></span></div><div style="color: rgb(171, 178, 191); text-shadow: rgba(0, 0, 0, 0.3) 0px 1px;"><span></span><span style="color: rgb(92, 99, 112);"># "above": indices with y_i &gt;= q; "below": indices with y_i &lt; q</span></div></pre></pre>
<p><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.625em; vertical-align: -0.1944em;"></span><span style="margin-right: 0.03588em;">q</span></span></span></span> is a <strong>weighted <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.4306em;"></span><span style="margin-right: 0.0037em;">α</span></span></span></span>-quantile</strong> of the current set.</p>
<hr>
<h2 id="2-algorithms">2. Algorithms</h2>
<h3 id="21-two-heaps-weighted-αalphaα-quantile-maintenance">2.1 Two-heaps (weighted <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.4306em;"></span><span style="margin-right: 0.0037em;">α</span></span></span></span>-quantile maintenance)</h3>
<p>This algorithm is a weighted adaptation of the two-heaps solution of the median of a>leetcode solution</a>)</p>
<p>Maintain two heaps keyed by <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.625em; vertical-align: -0.1944em;"></span><span style="margin-right: 0.03588em;">y</span></span></span></span>: a max-heap for items below <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.625em; vertical-align: -0.1944em;"></span><span style="margin-right: 0.03588em;">q</span></span></span></span> and a min-heap for items at/above <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.625em; vertical-align: -0.1944em;"></span><span style="margin-right: 0.03588em;">q</span></span></span></span>. Balance by <strong>total weight</strong> (not count) so that</p>
<span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>W</mi><mo>−</mo></msup><mo>≈</mo><mi>α</mi><mi>W</mi><mspace width="1em"></mspace><mtext>with&nbsp;</mtext><msup><mi>W</mi><mo>−</mo></msup><mo>=</mo><munder><mo>∑</mo><mrow><msub><mi>y</mi><mi>i</mi></msub><mo>&lt;</mo><mi>q</mi></mrow></munder><msub><mi>w</mi><mi>i</mi></msub><mtext> </mtext><mo separator="true">,</mo><mtext>  </mtext><mi>W</mi><mo>=</mo><msup><mi>W</mi><mo>−</mo></msup><mo>+</mo><msup><mi>W</mi><mo>+</mo></msup><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">W^- \approx \alpha W \quad \text{with } W^-= \sum_{y_i&lt;q} w_i \, , \; W=W^- + W^+.</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.8213em;"></span><span><span style="margin-right: 0.13889em;">W</span><span><span><span><span style="height: 0.8213em;"><span style="top: -3.113em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>−</span></span></span></span></span></span></span></span><span style="margin-right: 0.2778em;"></span><span>≈</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.8213em;"></span><span style="margin-right: 0.0037em;">α</span><span style="margin-right: 0.13889em;">W</span><span style="margin-right: 1em;"></span><span><span>with&nbsp;</span></span><span><span style="margin-right: 0.13889em;">W</span><span><span><span><span style="height: 0.8213em;"><span style="top: -3.113em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>−</span></span></span></span></span></span></span></span><span style="margin-right: 0.2778em;"></span><span>=</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 2.4361em; vertical-align: -1.3861em;"></span><span><span><span><span style="height: 1.05em;"><span style="top: -1.9em; margin-left: 0em;"><span style="height: 3.05em;"></span><span><span><span><span style="margin-right: 0.03588em;">y</span><span><span><span><span style="height: 0.3281em;"><span style="top: -2.357em; margin-left: -0.0359em; margin-right: 0.0714em;"><span style="height: 2.5em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.143em;"><span></span></span></span></span></span></span><span>&lt;</span><span style="margin-right: 0.03588em;">q</span></span></span></span><span style="top: -3.05em;"><span style="height: 3.05em;"></span><span><span>∑</span></span></span></span><span>​</span></span><span><span style="height: 1.3861em;"><span></span></span></span></span></span><span style="margin-right: 0.1667em;"></span><span><span style="margin-right: 0.02691em;">w</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span style="margin-right: 0.1667em;"></span><span>,</span><span style="margin-right: 0.2778em;"></span><span style="margin-right: 0.1667em;"></span><span style="margin-right: 0.13889em;">W</span><span style="margin-right: 0.2778em;"></span><span>=</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.9047em; vertical-align: -0.0833em;"></span><span><span style="margin-right: 0.13889em;">W</span><span><span><span><span style="height: 0.8213em;"><span style="top: -3.113em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>−</span></span></span></span></span></span></span></span><span style="margin-right: 0.2222em;"></span><span>+</span><span style="margin-right: 0.2222em;"></span></span><span><span style="height: 0.8213em;"></span><span><span style="margin-right: 0.13889em;">W</span><span><span><span><span style="height: 0.8213em;"><span style="top: -3.113em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>+</span></span></span></span></span></span></span></span><span>.</span></span></span></span></span>
<p>During a left→right sweep over samples sorted by the candidate feature:</p>
<ol>
<li>Insert <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>w</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(y_i,w_i)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span>(</span><span><span style="margin-right: 0.03588em;">y</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span>,</span><span style="margin-right: 0.1667em;"></span><span><span style="margin-right: 0.02691em;">w</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span>)</span></span></span></span> into the appropriate heap. Complexity: <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>lo<span style="margin-right: 0.01389em;">g</span></span><span style="margin-right: 0.1667em;"></span><span>n</span><span>)</span></span></span></span></li>
<li><strong>Rebalance by weight</strong> by moving boundary items across heaps until <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mo>−</mo></msup><mo>≈</mo><mi>α</mi><mi>W</mi></mrow><annotation encoding="application/x-tex">W^- \approx \alpha W</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.7713em;"></span><span><span style="margin-right: 0.13889em;">W</span><span><span><span><span style="height: 0.7713em;"><span style="top: -3.063em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>−</span></span></span></span></span></span></span></span><span style="margin-right: 0.2778em;"></span><span>≈</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.6833em;"></span><span style="margin-right: 0.0037em;">α</span><span style="margin-right: 0.13889em;">W</span></span></span></span>. <strong>Expected</strong> complexity: <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>lo<span style="margin-right: 0.01389em;">g</span></span><span style="margin-right: 0.1667em;"></span><span>n</span><span>)</span></span></span></span>, see section 3 for more details.</li>
<li>Read off <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.625em; vertical-align: -0.1944em;"></span><span style="margin-right: 0.03588em;">q</span></span></span></span> at the boundary and compute the child loss with the <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>1</span><span>)</span></span></span></span> formula.</li>
</ol>
<p>A symmetric right→left sweep yields the right-child losses; summing gives the impurity at each threshold.</p>
<p><strong>Implementation:</strong></p>
<ul>
<li>A simple python WeightedHeap (wraps stdlib's <code>heapq</code>): <code>lib/ds/pythonheap.py</code></li>
<li>A numba WeightedHeap: <code>lib/ds/heap.py</code></li>
<li>The left→right sweep loop: <code>lib/algos/heap.py</code></li>
</ul>
<h3 id="22-segment-tree-guaranteed-onlognonlog-nonlogn">2.2 Segment tree (guaranteed <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n\log n)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>n</span><span style="margin-right: 0.1667em;"></span><span>lo<span style="margin-right: 0.01389em;">g</span></span><span style="margin-right: 0.1667em;"></span><span>n</span><span>)</span></span></span></span>)</h3>
<p><strong>Idea.</strong> Maintain a static binary tree over the <strong>sorted order of targets <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.625em; vertical-align: -0.1944em;"></span><span style="margin-right: 0.03588em;">y</span></span></span></span></strong>. Each leaf corresponds to one <strong>rank</strong> position in that sorted order (smallest <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">y_i</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.625em; vertical-align: -0.1944em;"></span><span><span style="margin-right: 0.03588em;">y</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span> has rank <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.6444em;"></span><span>0</span></span></span></span> and so on); every internal node stores two aggregates for its subtree:</p>
<ul>
<li>total weight <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi></mrow><annotation encoding="application/x-tex">W</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.6833em;"></span><span style="margin-right: 0.13889em;">W</span></span></span></span> and</li>
<li>total weighted target <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>=</mo><mo>∑</mo><msub><mi>w</mi><mi>i</mi></msub><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">Y=\sum w_i y_i</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.6833em;"></span><span style="margin-right: 0.22222em;">Y</span><span style="margin-right: 0.2778em;"></span><span>=</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="position: relative; top: 0em;">∑</span><span style="margin-right: 0.1667em;"></span><span><span style="margin-right: 0.02691em;">w</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span><span style="margin-right: 0.03588em;">y</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span>.</li>
</ul>
<p>The tree is initialized with all aggregates set to zero—that is, all leaves start “empty.”</p>
<p>This lets us (i) <strong>set</strong> the current sample’s <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>w</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(y_i, w_i)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span>(</span><span><span style="margin-right: 0.03588em;">y</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span>,</span><span style="margin-right: 0.1667em;"></span><span><span style="margin-right: 0.02691em;">w</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span>)</span></span></span></span> at its leaf (i.e. at the <strong>rank</strong> of <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">y_i</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.625em; vertical-align: -0.1944em;"></span><span><span style="margin-right: 0.03588em;">y</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span>), updating <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi></mrow><annotation encoding="application/x-tex">W</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.6833em;"></span><span style="margin-right: 0.13889em;">W</span></span></span></span> and <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.6833em;"></span><span style="margin-right: 0.22222em;">Y</span></span></span></span> up the path, and (ii) <strong>search</strong> by <strong>cumulative weight</strong> to find the weighted <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.4306em;"></span><span style="margin-right: 0.0037em;">α</span></span></span></span>-quantile and the prefix aggregates needed for the <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>1</span><span>)</span></span></span></span> pinball-loss formula.</p>
<p><strong>Operations.</strong></p>
<ul>
<li><strong>SET(rank, <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi></mrow><annotation encoding="application/x-tex">w</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.4306em;"></span><span style="margin-right: 0.02691em;">w</span></span></span></span>, <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.625em; vertical-align: -0.1944em;"></span><span style="margin-right: 0.03588em;">y</span></span></span></span>)</strong>: add <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>w</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(w,y)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span>(</span><span style="margin-right: 0.02691em;">w</span><span>,</span><span style="margin-right: 0.1667em;"></span><span style="margin-right: 0.03588em;">y</span><span>)</span></span></span></span> to the leaf at <code>rank</code>; bubble updates to the root, maintaining subtree aggregates <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>W</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(W,Y)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span>(</span><span style="margin-right: 0.13889em;">W</span><span>,</span><span style="margin-right: 0.1667em;"></span><span style="margin-right: 0.22222em;">Y</span><span>)</span></span></span></span>. Cost <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>lo<span style="margin-right: 0.01389em;">g</span></span><span style="margin-right: 0.1667em;"></span><span>n</span><span>)</span></span></span></span>.</li>
<li><strong>SEARCH(<span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.6151em;"></span><span>t</span></span></span></span>)</strong>: given a weight target <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>=</mo><mi>α</mi><mo>⋅</mo><msub><mi>W</mi><mtext>total</mtext></msub></mrow><annotation encoding="application/x-tex">t=\alpha \cdot W_{\text{total}}</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.6151em;"></span><span>t</span><span style="margin-right: 0.2778em;"></span><span>=</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.4445em;"></span><span style="margin-right: 0.0037em;">α</span><span style="margin-right: 0.2222em;"></span><span>⋅</span><span style="margin-right: 0.2222em;"></span></span><span><span style="height: 0.8333em; vertical-align: -0.15em;"></span><span><span style="margin-right: 0.13889em;">W</span><span><span><span><span style="height: 0.3361em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span><span><span>total</span></span></span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span>, descend from the root choosing left/right by comparing (t) to the left child’s weight. This finds the <strong>leaf</strong> where the weighted rank crosses (t); along the way you accumulate the <strong>prefix</strong> (W^-) and (Y^-). Return ((W^-, Y^-, q)) where (q) is the leaf’s (y)-value (the current weighted (\alpha)-quantile). Cost (O(\log n)).</li>
</ul>
<p>(A symmetric right→left sweep yields right-child losses; add left+right to score each threshold.)</p>
<p><strong>Complexity and performance.</strong></p>
<ul>
<li>Each step performs one <code>SET</code> and one <code>SEARCH</code>: <strong><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>lo<span style="margin-right: 0.01389em;">g</span></span><span style="margin-right: 0.1667em;"></span><span>n</span><span>)</span></span></span></span></strong> each ⇒ <strong><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n\log n)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>n</span><span style="margin-right: 0.1667em;"></span><span>lo<span style="margin-right: 0.01389em;">g</span></span><span style="margin-right: 0.1667em;"></span><span>n</span><span>)</span></span></span></span></strong> per sweep, worst-case by design.</li>
<li>In practice this variant is typically <strong>~3× slower</strong> than the two-heaps method on the same data (larger constants, more memory traffic), but it provides a clean upper bound and deterministic per-step work.</li>
</ul>
<p><strong>Implementation.</strong></p>
<ul>
<li>The weighted segment tree class: <code>lib/ds/segment_tree.py</code></li>
<li>The left→right sweep loop: <code>lib/algos/segment_tree.py</code></li>
</ul>
<hr>
<h2 id="3-complexity-of-the-two-heaps-algorithm">3. Complexity of the two-heaps algorithm</h2>
<p>See the notebook <a href="https://github.com/cakedev0/fast-mae-split/blob/main/complexity_experiments.ipynb">complexity_experiments</a> for experiments and plots illustrating the different statements of this section.</p>
<h3 id="31-worst-case-for-two-heaps">3.1 Worst-case for two-heaps</h3>
<p>In adversarial orders of weights, a single insertion can force the <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.4306em;"></span><span style="margin-right: 0.0037em;">α</span></span></span></span>-quantile boundary to traverse <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Θ</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Theta(n)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span>Θ</span><span>(</span><span>n</span><span>)</span></span></span></span> items (each move is a heap pop+push, <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>lo<span style="margin-right: 0.01389em;">g</span></span><span style="margin-right: 0.1667em;"></span><span>n</span><span>)</span></span></span></span>). Thus <strong>worst-case</strong> per insertion is <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n\log n)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>n</span><span style="margin-right: 0.1667em;"></span><span>lo<span style="margin-right: 0.01389em;">g</span></span><span style="margin-right: 0.1667em;"></span><span>n</span><span>)</span></span></span></span> and a full sweep can be <strong><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^2\log n)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1.0641em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span><span>n</span><span><span><span><span style="height: 0.8141em;"><span style="top: -3.063em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>2</span></span></span></span></span></span></span></span><span style="margin-right: 0.1667em;"></span><span>lo<span style="margin-right: 0.01389em;">g</span></span><span style="margin-right: 0.1667em;"></span><span>n</span><span>)</span></span></span></span></strong>.</p>
<p>This does <strong>not</strong> occur in typical data; it requires systematically placing extreme weights to repeatedly push the boundary across many tiny items.</p>
<h3 id="32-expected-onlognonlog-nonlogn-per-feature--two-versions">3.2 Expected <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n\log n)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>n</span><span style="margin-right: 0.1667em;"></span><span>lo<span style="margin-right: 0.01389em;">g</span></span><span style="margin-right: 0.1667em;"></span><span>n</span><span>)</span></span></span></span> per feature — two versions</h3>
<p>We give two simple sets of conditions under which the <strong>expected</strong> number of boundary moves per insertion is <strong><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>1</span><span>)</span></span></span></span></strong>, yielding <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n\log n)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>n</span><span style="margin-right: 0.1667em;"></span><span>lo<span style="margin-right: 0.01389em;">g</span></span><span style="margin-right: 0.1667em;"></span><span>n</span><span>)</span></span></span></span> total expected time (insert + moves, each <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>lo<span style="margin-right: 0.01389em;">g</span></span><span style="margin-right: 0.1667em;"></span><span>n</span><span>)</span></span></span></span>).</p>
<hr>
<h4 id="32a-independence-model-ywy-perp-wyw">3.2A Independence model: <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>⊥</mo><mi>W</mi></mrow><annotation encoding="application/x-tex">Y \perp W</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.6944em;"></span><span style="margin-right: 0.22222em;">Y</span><span style="margin-right: 0.2778em;"></span><span>⊥</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.6833em;"></span><span style="margin-right: 0.13889em;">W</span></span></span></span></h4>
<p><strong>Assumptions.</strong></p>
<ul>
<li><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>Y</mi><mi>n</mi></msub><mtext>  </mtext></mrow><annotation encoding="application/x-tex">Y_1, \dots, Y_n\;</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.8778em; vertical-align: -0.1944em;"></span><span><span style="margin-right: 0.22222em;">Y</span><span><span><span><span style="height: 0.3011em;"><span style="top: -2.55em; margin-left: -0.2222em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>1</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span>,</span><span style="margin-right: 0.1667em;"></span><span>…</span><span style="margin-right: 0.1667em;"></span><span>,</span><span style="margin-right: 0.1667em;"></span><span><span style="margin-right: 0.22222em;">Y</span><span><span><span><span style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.2222em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>n</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span style="margin-right: 0.2778em;"></span></span></span></span> i.i.d. from a continuous distribution (or consistent tie-breaking).</li>
<li><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>W</mi><mi>n</mi></msub><mtext>  </mtext></mrow><annotation encoding="application/x-tex">W_1, \dots, W_n\;</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.8778em; vertical-align: -0.1944em;"></span><span><span style="margin-right: 0.13889em;">W</span><span><span><span><span style="height: 0.3011em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>1</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span>,</span><span style="margin-right: 0.1667em;"></span><span>…</span><span style="margin-right: 0.1667em;"></span><span>,</span><span style="margin-right: 0.1667em;"></span><span><span style="margin-right: 0.13889em;">W</span><span><span><span><span style="height: 0.1514em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>n</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span style="margin-right: 0.2778em;"></span></span></span></span> i.i.d., non-negative, independent of the <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">Y_i</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.8333em; vertical-align: -0.15em;"></span><span><span style="margin-right: 0.22222em;">Y</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.2222em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span></span></span></span>, with <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>&lt;</mo><mi>μ</mi><mo>=</mo><mi mathvariant="double-struck">E</mi><mo stretchy="false">[</mo><msub><mi>W</mi><mi>i</mi></msub><mo stretchy="false">]</mo><mo>&lt;</mo><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">0&lt;\mu=\mathbb{E}[W_i]&lt;\infty</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.6835em; vertical-align: -0.0391em;"></span><span>0</span><span style="margin-right: 0.2778em;"></span><span>&lt;</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.625em; vertical-align: -0.1944em;"></span><span>μ</span><span style="margin-right: 0.2778em;"></span><span>=</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 1em; vertical-align: -0.25em;"></span><span>E</span><span>[</span><span><span style="margin-right: 0.13889em;">W</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span>]</span><span style="margin-right: 0.2778em;"></span><span>&lt;</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.4306em;"></span><span>∞</span></span></span></span>.</li>
</ul>
<p><strong>Intuition.</strong> Insert <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>Y</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><msub><mi>W</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(Y_{t+1},W_{t+1})</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span>(</span><span><span style="margin-right: 0.22222em;">Y</span><span><span><span><span style="height: 0.3011em;"><span style="top: -2.55em; margin-left: -0.2222em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span><span>t</span><span>+</span><span>1</span></span></span></span></span><span>​</span></span><span><span style="height: 0.2083em;"><span></span></span></span></span></span></span><span>,</span><span style="margin-right: 0.1667em;"></span><span><span style="margin-right: 0.13889em;">W</span><span><span><span><span style="height: 0.3011em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span><span>t</span><span>+</span><span>1</span></span></span></span></span><span>​</span></span><span><span style="height: 0.2083em;"><span></span></span></span></span></span></span><span>)</span></span></span></span>. The target balance changes by at most the new weight, so the boundary must “absorb” weight</p>
<span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>B</mi><mi>t</mi></msub><mo>∈</mo><mrow><mi>α</mi><msub><mi>W</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>α</mi><mo stretchy="false">)</mo><msub><mi>W</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><mo>≤</mo><msub><mi>W</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">B_t\in{\alpha W_{t+1}, (1-\alpha)W_{t+1}}\le W_{t+1}.</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.8333em; vertical-align: -0.15em;"></span><span><span style="margin-right: 0.05017em;">B</span><span><span><span><span style="height: 0.2806em;"><span style="top: -2.55em; margin-left: -0.0502em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>t</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span style="margin-right: 0.2778em;"></span><span>∈</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 1em; vertical-align: -0.25em;"></span><span><span style="margin-right: 0.0037em;">α</span><span><span style="margin-right: 0.13889em;">W</span><span><span><span><span style="height: 0.3011em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span><span>t</span><span>+</span><span>1</span></span></span></span></span><span>​</span></span><span><span style="height: 0.2083em;"><span></span></span></span></span></span></span><span>,</span><span style="margin-right: 0.1667em;"></span><span>(</span><span>1</span><span style="margin-right: 0.2222em;"></span><span>−</span><span style="margin-right: 0.2222em;"></span><span style="margin-right: 0.0037em;">α</span><span>)</span><span><span style="margin-right: 0.13889em;">W</span><span><span><span><span style="height: 0.3011em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span><span>t</span><span>+</span><span>1</span></span></span></span></span><span>​</span></span><span><span style="height: 0.2083em;"><span></span></span></span></span></span></span></span><span style="margin-right: 0.2778em;"></span><span>≤</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.8917em; vertical-align: -0.2083em;"></span><span><span style="margin-right: 0.13889em;">W</span><span><span><span><span style="height: 0.3011em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span><span>t</span><span>+</span><span>1</span></span></span></span></span><span>​</span></span><span><span style="height: 0.2083em;"><span></span></span></span></span></span></span><span>.</span></span></span></span></span>
<p>To re-balance, we move boundary items one by one. By independence and continuity, the weights encountered at the boundary look like fresh draws from <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi></mrow><annotation encoding="application/x-tex">W</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.6833em;"></span><span style="margin-right: 0.13889em;">W</span></span></span></span>, so a <strong>typical boundary item contributes <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≈</mo><mi>μ</mi></mrow><annotation encoding="application/x-tex">\approx \mu</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.4831em;"></span><span>≈</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.625em; vertical-align: -0.1944em;"></span><span>μ</span></span></span></span> weight</strong>. Hence the expected number of moves is about <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">E</mi><mo stretchy="false">[</mo><msub><mi>B</mi><mi>t</mi></msub><mo stretchy="false">]</mo><mi mathvariant="normal">/</mi><mi>μ</mi><mo>≤</mo><mi>μ</mi><mi mathvariant="normal">/</mi><mi>μ</mi><mo>=</mo><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbb{E}[B_t]/\mu\le \mu/\mu=O(1)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span>E</span><span>[</span><span><span style="margin-right: 0.05017em;">B</span><span><span><span><span style="height: 0.2806em;"><span style="top: -2.55em; margin-left: -0.0502em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>t</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span>]</span><span>/</span><span>μ</span><span style="margin-right: 0.2778em;"></span><span>≤</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 1em; vertical-align: -0.25em;"></span><span>μ</span><span>/</span><span>μ</span><span style="margin-right: 0.2778em;"></span><span>=</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>1</span><span>)</span></span></span></span> (up to a constant for the final overshoot). Each move costs <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>lo<span style="margin-right: 0.01389em;">g</span></span><span style="margin-right: 0.1667em;"></span><span>n</span><span>)</span></span></span></span>; adding the <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>lo<span style="margin-right: 0.01389em;">g</span></span><span style="margin-right: 0.1667em;"></span><span>n</span><span>)</span></span></span></span> insertion yields <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>lo<span style="margin-right: 0.01389em;">g</span></span><span style="margin-right: 0.1667em;"></span><span>n</span><span>)</span></span></span></span> expected time per sample and <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n\log n)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>n</span><span style="margin-right: 0.1667em;"></span><span>lo<span style="margin-right: 0.01389em;">g</span></span><span style="margin-right: 0.1667em;"></span><span>n</span><span>)</span></span></span></span> per feature.</p>
<p><strong>Remark.</strong> Heavy tails with finite mean (e.g., log-normal, Pareto with <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>&gt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\alpha&gt;1</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.5782em; vertical-align: -0.0391em;"></span><span style="margin-right: 0.0037em;">α</span><span style="margin-right: 0.2778em;"></span><span>&gt;</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.6444em;"></span><span>1</span></span></span></span>) increase variance but not the expectation; infinite-mean tails would break the bound. However, in practice, even with infinite-mean Pareto distributions, performance does not degrade significantly.</p>
<hr>
<h4 id="32b-lower-bound-model-fyewyyc0fymathbbewmid-yyge-c0fyewyyc0">3.2B Lower-bound model: <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><mi mathvariant="double-struck">E</mi><mo stretchy="false">[</mo><mi>W</mi><mo>∣</mo><mi>Y</mi><mo>=</mo><mi>y</mi><mo stretchy="false">]</mo><mo>≥</mo><mi>c</mi><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">f(y)=\mathbb{E}[W\mid Y=y]\ge c&gt;0</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.10764em;">f</span><span>(</span><span style="margin-right: 0.03588em;">y</span><span>)</span><span style="margin-right: 0.2778em;"></span><span>=</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 1em; vertical-align: -0.25em;"></span><span>E</span><span>[</span><span style="margin-right: 0.13889em;">W</span><span style="margin-right: 0.2778em;"></span><span>∣</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.6833em;"></span><span style="margin-right: 0.22222em;">Y</span><span style="margin-right: 0.2778em;"></span><span>=</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.03588em;">y</span><span>]</span><span style="margin-right: 0.2778em;"></span><span>≥</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.5782em; vertical-align: -0.0391em;"></span><span>c</span><span style="margin-right: 0.2778em;"></span><span>&gt;</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.6444em;"></span><span>0</span></span></span></span></h4>
<p><strong>Assumptions.</strong></p>
<ul>
<li><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>Y</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>W</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(Y_i,W_i)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span>(</span><span><span style="margin-right: 0.22222em;">Y</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.2222em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span>,</span><span style="margin-right: 0.1667em;"></span><span><span style="margin-right: 0.13889em;">W</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span>)</span></span></span></span> are i.i.d.; <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi><mo>=</mo><mi mathvariant="double-struck">E</mi><mo stretchy="false">[</mo><msub><mi>W</mi><mi>i</mi></msub><mo stretchy="false">]</mo><mo>&lt;</mo><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">\mu=\mathbb{E}[W_i]&lt;\infty</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.625em; vertical-align: -0.1944em;"></span><span>μ</span><span style="margin-right: 0.2778em;"></span><span>=</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 1em; vertical-align: -0.25em;"></span><span>E</span><span>[</span><span><span style="margin-right: 0.13889em;">W</span><span><span><span><span style="height: 0.3117em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>i</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span>]</span><span style="margin-right: 0.2778em;"></span><span>&lt;</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.4306em;"></span><span>∞</span></span></span></span>.</li>
<li><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.6833em;"></span><span style="margin-right: 0.22222em;">Y</span></span></span></span> has a continuous distribution (or consistent tie-breaking).</li>
<li>There exists <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">c&gt;0</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.5782em; vertical-align: -0.0391em;"></span><span>c</span><span style="margin-right: 0.2778em;"></span><span>&gt;</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.6444em;"></span><span>0</span></span></span></span> such that for all <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.625em; vertical-align: -0.1944em;"></span><span style="margin-right: 0.03588em;">y</span></span></span></span> in the support of <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.6833em;"></span><span style="margin-right: 0.22222em;">Y</span></span></span></span>,
<span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo><mo>:</mo><mo>=</mo><mi mathvariant="double-struck">E</mi><mo stretchy="false">[</mo><mi>W</mi><mo>∣</mo><mi>Y</mi><mo>=</mo><mi>y</mi><mo stretchy="false">]</mo><mtext>&nbsp;</mtext><mo>≥</mo><mtext>&nbsp;</mtext><mi>c</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">f(y):=\mathbb{E}[W\mid Y=y]\ \ge\ c.</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.10764em;">f</span><span>(</span><span style="margin-right: 0.03588em;">y</span><span>)</span><span style="margin-right: 0.2778em;"></span><span>:=</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 1em; vertical-align: -0.25em;"></span><span>E</span><span>[</span><span style="margin-right: 0.13889em;">W</span><span style="margin-right: 0.2778em;"></span><span>∣</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.6833em;"></span><span style="margin-right: 0.22222em;">Y</span><span style="margin-right: 0.2778em;"></span><span>=</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.03588em;">y</span><span>]</span><span>&nbsp;</span><span style="margin-right: 0.2778em;"></span><span>≥</span><span>&nbsp;</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.4306em;"></span><span>c</span><span>.</span></span></span></span></span>
</li>
</ul>
<p><strong>Intuition.</strong> As above, each insertion requires shifting at most <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>t</mi></msub><mo>≤</mo><msub><mi>W</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">B_t\le W_{t+1}</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.8333em; vertical-align: -0.15em;"></span><span><span style="margin-right: 0.05017em;">B</span><span><span><span><span style="height: 0.2806em;"><span style="top: -2.55em; margin-left: -0.0502em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>t</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span style="margin-right: 0.2778em;"></span><span>≤</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.8917em; vertical-align: -0.2083em;"></span><span><span style="margin-right: 0.13889em;">W</span><span><span><span><span style="height: 0.3011em;"><span style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span><span>t</span><span>+</span><span>1</span></span></span></span></span><span>​</span></span><span><span style="height: 0.2083em;"><span></span></span></span></span></span></span></span></span></span> weight across the boundary. The items encountered while sliding the boundary have an <strong>expected weight of at least <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.4306em;"></span><span>c</span></span></span></span></strong>. Therefore, the <strong>expected number of moves</strong> satisfies</p>
<span><span><span><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="double-struck">E</mi><mo stretchy="false">[</mo><msub><mi>K</mi><mi>t</mi></msub><mo stretchy="false">]</mo><mtext>&nbsp;</mtext><mo>≲</mo><mtext>&nbsp;</mtext><mfrac><mrow><mi mathvariant="double-struck">E</mi><mo stretchy="false">[</mo><msub><mi>B</mi><mi>t</mi></msub><mo stretchy="false">]</mo></mrow><mi>c</mi></mfrac><mo>+</mo><mn>1</mn><mtext>&nbsp;</mtext><mo>≤</mo><mtext>&nbsp;</mtext><mfrac><mi>μ</mi><mi>c</mi></mfrac><mo>+</mo><mn>1</mn><mtext>&nbsp;</mtext><mo>=</mo><mtext>&nbsp;</mtext><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">\mathbb{E}[K_t]\ \lesssim\ \frac{\mathbb{E}[B_t]}{c} + 1 \ \le\ \frac{\mu}{c}+1 \ =\ O(1).</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span>E</span><span>[</span><span><span style="margin-right: 0.07153em;">K</span><span><span><span><span style="height: 0.2806em;"><span style="top: -2.55em; margin-left: -0.0715em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>t</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span>]</span><span>&nbsp;</span><span style="margin-right: 0.2778em;"></span><span>≲</span><span>&nbsp;</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 2.113em; vertical-align: -0.686em;"></span><span><span></span><span><span><span><span style="height: 1.427em;"><span style="top: -2.314em;"><span style="height: 3em;"></span><span><span>c</span></span></span><span style="top: -3.23em;"><span style="height: 3em;"></span><span style="border-bottom-width: 0.04em;"></span></span><span style="top: -3.677em;"><span style="height: 3em;"></span><span><span>E</span><span>[</span><span><span style="margin-right: 0.05017em;">B</span><span><span><span><span style="height: 0.2806em;"><span style="top: -2.55em; margin-left: -0.0502em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>t</span></span></span></span><span>​</span></span><span><span style="height: 0.15em;"><span></span></span></span></span></span></span><span>]</span></span></span></span><span>​</span></span><span><span style="height: 0.686em;"><span></span></span></span></span></span><span></span></span><span style="margin-right: 0.2222em;"></span><span>+</span><span style="margin-right: 0.2222em;"></span></span><span><span style="height: 0.7804em; vertical-align: -0.136em;"></span><span>1</span><span>&nbsp;</span><span style="margin-right: 0.2778em;"></span><span>≤</span><span>&nbsp;</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 1.7936em; vertical-align: -0.686em;"></span><span><span></span><span><span><span><span style="height: 1.1076em;"><span style="top: -2.314em;"><span style="height: 3em;"></span><span><span>c</span></span></span><span style="top: -3.23em;"><span style="height: 3em;"></span><span style="border-bottom-width: 0.04em;"></span></span><span style="top: -3.677em;"><span style="height: 3em;"></span><span><span>μ</span></span></span></span><span>​</span></span><span><span style="height: 0.686em;"><span></span></span></span></span></span><span></span></span><span style="margin-right: 0.2222em;"></span><span>+</span><span style="margin-right: 0.2222em;"></span></span><span><span style="height: 0.6444em;"></span><span>1</span><span>&nbsp;</span><span style="margin-right: 0.2778em;"></span><span>=</span><span>&nbsp;</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>1</span><span>)</span><span>.</span></span></span></span></span>
<p>Again, with <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>lo<span style="margin-right: 0.01389em;">g</span></span><span style="margin-right: 0.1667em;"></span><span>n</span><span>)</span></span></span></span> per move and insertion, we obtain <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n\log n)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>n</span><span style="margin-right: 0.1667em;"></span><span>lo<span style="margin-right: 0.01389em;">g</span></span><span style="margin-right: 0.1667em;"></span><span>n</span><span>)</span></span></span></span> expected time, but with possibly a much bigger constant than above, if <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mi>μ</mi><mi>c</mi></mfrac></mrow><annotation encoding="application/x-tex">\frac{\mu}{c}</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1.0925em; vertical-align: -0.345em;"></span><span><span></span><span><span><span><span style="height: 0.7475em;"><span style="top: -2.655em;"><span style="height: 3em;"></span><span><span><span>c</span></span></span></span><span style="top: -3.23em;"><span style="height: 3em;"></span><span style="border-bottom-width: 0.04em;"></span></span><span style="top: -3.4461em;"><span style="height: 3em;"></span><span><span><span>μ</span></span></span></span></span><span>​</span></span><span><span style="height: 0.345em;"><span></span></span></span></span></span><span></span></span></span></span></span> is big. See graph <em>small_weights_around_median</em> in <code>complexity_experiments.ipynb</code> for an example of such a setting.</p>
<hr>
<h2 id="4-empirical-performance-illustrative">4. Empirical performance (illustrative)</h2>
<ul>
<li><strong>Setup:</strong> <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mn>100,000</mn></mrow><annotation encoding="application/x-tex">n=100{,}000</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.4306em;"></span><span>n</span><span style="margin-right: 0.2778em;"></span><span>=</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.8389em; vertical-align: -0.1944em;"></span><span>100</span><span><span>,</span></span><span>000</span></span></span></span></li>
<li><strong>Previous <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^2)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1.0641em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span><span>n</span><span><span><span><span style="height: 0.8141em;"><span style="top: -3.063em; margin-right: 0.05em;"><span style="height: 2.7em;"></span><span><span>2</span></span></span></span></span></span></span></span><span>)</span></span></span></span> MAE path:</strong> <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∼</mo><mn>10</mn></mrow><annotation encoding="application/x-tex">\sim 10</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.3669em;"></span><span>∼</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.6444em;"></span><span>10</span></span></span></span> s.</li>
<li><strong>Two-heaps:</strong> <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∼</mo><mn>0.2</mn></mrow><annotation encoding="application/x-tex">\sim 0.2</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.3669em;"></span><span>∼</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 0.6444em;"></span><span>0.2</span></span></span></span> s.</li>
<li><strong>Segment tree:</strong> typically ~3× slower than two-heaps on the same data, expect for adversial input,
or low mean around quantile case: <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">E</mi><mo stretchy="false">[</mo><mi>W</mi><mi mathvariant="normal">∣</mi><mi>y</mi><mo>≈</mo><mi>q</mi><mo stretchy="false">]</mo><mo>&lt;</mo><mo>&lt;</mo><mi mathvariant="double-struck">E</mi><mo stretchy="false">[</mo><mi>W</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\mathbb{E}[W|y \approx q] &lt;&lt; \mathbb{E}[W]</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span>E</span><span>[</span><span style="margin-right: 0.13889em;">W</span><span>∣</span><span style="margin-right: 0.03588em;">y</span><span style="margin-right: 0.2778em;"></span><span>≈</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.03588em;">q</span><span>]</span><span style="margin-right: 0.2778em;"></span><span>&lt;&lt;</span><span style="margin-right: 0.2778em;"></span></span><span><span style="height: 1em; vertical-align: -0.25em;"></span><span>E</span><span>[</span><span style="margin-right: 0.13889em;">W</span><span>]</span></span></span></span>.</li>
</ul>
<hr>
<h2 id="5-related-work-brief">5. Related work (brief)</h2>
<p>This approach adapts the classic two-heaps streaming median to <strong>weighted <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 0.4306em;"></span><span style="margin-right: 0.0037em;">α</span></span></span></span>-quantiles</strong> and couples it with a simple <span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>1</span><span>)</span></span></span></span> pinball-loss evaluation. Some <a href="https://faculty.ucmerced.edu/hbhat/BhatKumarVaz_final.pdf">prior work</a> also proposes a two-heaps algorithm for quantile-regression trees, but it omits weights and rely on more elaborate derivations for pinball-loss evaluation (<span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span aria-hidden="true"><span><span style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.02778em;">O</span><span>(</span><span>1</span><span>)</span></span></span></span> too, but might not be easy to adapt for the weighted case). The present formulation is simple and easy to integrate into open-source libraries such as scikit-learn.</p>